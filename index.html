<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EPUB Reader ‚Äî Highlights (Orange)</title>

<!-- B·∫ÆT BU·ªòC: JSZip tr∆∞·ªõc, epub.js sau -->
<script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.js"></script>

<style>
  :root{
    --bg:#0b1020; --card:#0e162b; --muted:#9aa4b2; --text:#eaf0ff; --line:#1f2b4a;
    --accent:#38bdf8; --orange:#f59e0b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(120deg,#0b1020,#101736);
  }
  header{
    position:sticky; top:0; z-index:10;
    display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;
    padding:.6rem .8rem; background:rgba(14,22,43,.9); backdrop-filter:blur(6px);
    border-bottom:1px solid var(--line)
  }
  .btn{
    border:1px solid #2a3a63; background:#152043; color:var(--text);
    padding:.5rem .8rem; border-radius:.6rem; cursor:pointer
  }
  .btn.primary{ border-color:#3aa0ff; background:#16294b }
  .btn:disabled{ opacity:.5; cursor:not-allowed }
  input[type="file"]{ display:none }
  .chip{ padding:.35rem .6rem; border:1px solid #2a3a63; border-radius:999px; font-size:.9rem }
  .grow{ flex:1 }
  #status{ font-size:.9rem; color:var(--muted) }

  /* B·ªë c·ª•c 3 c·ªôt: TOC | Reader | Highlights */
  #wrap{
    display:grid; gap:.8rem; padding:.8rem;
    grid-template-columns:260px 1fr 320px;
    min-height:calc(100vh - 64px)
  }
  /* TOC */
  #toc{
    background:rgba(14,22,43,.6); border:1px solid var(--line);
    border-radius:.8rem; padding:.6rem; overflow:auto
  }
  #toc h3{ margin:.2rem .4rem .6rem; color:#a7b4c9; font-size:.95rem }
  #toc a{ display:block; color:#cfe3ff; text-decoration:none; padding:.35rem .45rem; border-radius:.4rem }
  #toc a:hover{ background:#1a2647 }

  /* Stage (reader) */
  #stage{
    background:rgba(14,22,43,.6); border:1px solid var(--line); border-radius:.8rem;
    position:relative; min-height:360px
  }
  #area{ width:100%; height:100%; overflow:auto } /* chi·ªÅu cao set b·∫±ng JS ƒë·ªÉ ch·∫Øc ch·∫Øn kh√¥ng = 0 */
  #overlay{
    position:absolute; inset:0; display:none; place-items:center;
    background:rgba(16,23,54,.4); backdrop-filter:blur(2px)
  }

  /* Panel Highlights b√™n ph·∫£i */
  #notes{
    background:rgba(14,22,43,.6); border:1px solid var(--line);
    border-radius:.8rem; padding:.6rem; overflow:auto
  }
  #notes h3{ margin:.2rem .4rem .6rem; color:#a7b4c9; font-size:.95rem }
  .note{
    border:1px solid #2a3a63; border-radius:.6rem; padding:.5rem .6rem; margin:.45rem 0;
    background:#121c36; cursor:pointer
  }
  .note small{ color:#9fb3d1; display:block; margin-top:.25rem }
  .note:hover{ outline:1px solid #3b4f85 }

  /* M√†u highlight trong ebook iframe */
  .epubjs-hl{ background:rgba(245,158,11,.45) !important; box-shadow:0 0 0 2px rgba(245,158,11,.25) inset }

  @media (max-width:1100px){
    #wrap{ grid-template-columns:1fr; }
    #notes{ order:3; max-height:260px }
    #toc{ max-height:220px }
  }
</style>
</head>
<body>
<header>
  <label class="btn primary" for="file">üìñ Ch·ªçn EPUB</label>
  <input id="file" type="file" accept=".epub">
  <button id="prev" class="btn">‚üµ Prev</button>
  <button id="next" class="btn">Next ‚ü∂</button>
  <span class="chip">C·ª° ch·ªØ: <input id="font" type="range" min="80" max="160" value="100">%</span>

  <!-- N√∫t highlight m√†u cam -->
  <button id="addHL" class="btn" disabled>üñçÔ∏è Highlight (cam)</button>

  <span class="chip">Trang: <span id="loc">‚Äî</span></span>
  <div class="grow"></div>
  <span id="status">S·∫µn s√†ng. Ch·ªçn/k√©o‚Äëth·∫£ .epub, b√¥i ƒëen r·ªìi b·∫•m ‚ÄúHighlight (cam)‚Äù.</span>
</header>

<div id="wrap">
  <nav id="toc"><h3>M·ª•c l·ª•c</h3><div id="tocItems"></div></nav>

  <section id="stage">
    <div id="area" tabindex="0"></div>
    <div id="overlay" style="display:grid"><div>
      <div style="font-size:1.2rem;text-align:center">‚è≥ ƒêang m·ªü EPUB‚Ä¶</div>
    </div></div>
  </section>

  <aside id="notes">
    <h3>Highlights (cam)</h3>
    <div id="noteList"></div>
  </aside>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const fileInput = $('file'), area = $('area'), stage = $('stage'), overlay = $('overlay');
  const prevBtn = $('prev'), nextBtn = $('next'), fontRange = $('font'), addHLBtn = $('addHL');
  const loc = $('loc'), status = $('status'), tocItems = $('tocItems'), noteList = $('noteList');

  let book = null, rendition = null;
  let lastSelection = null; // { cfi, text }

  function setStatus(s){ status.textContent = s; }
  function clearTOC(){ tocItems.innerHTML = ""; }
  function ensureHeight(){
    const h = stage.clientHeight || 400;
    area.style.height = h + 'px';
  }
  new ResizeObserver(ensureHeight).observe(stage);
  ensureHeight();

  function buildTOC(navs){
    clearTOC();
    const add = items => items.forEach(it=>{
      const a = document.createElement('a');
      a.textContent = (it.label||'').trim() || '(no title)';
      a.href = '#';
      a.addEventListener('click', e=>{ e.preventDefault(); rendition.display(it.href); });
      tocItems.appendChild(a);
      if (it.subitems?.length) add(it.subitems);
    });
    add(navs.toc || []);
  }

  function renderNotes(){
    noteList.innerHTML = '';
    highlights.forEach((h, i) => {
      const div = document.createElement('div');
      div.className = 'note';
      div.title = 'Nh·∫•n ƒë·ªÉ nh·∫£y t·ªõi v·ªã tr√≠ highlight';
      div.innerHTML = `<div>${escapeHtml(h.text || '(tr·ªëng)')}</div>
                       <small>${h.chapter || ''}</small>`;
      div.addEventListener('click', ()=> rendition.display(h.cfi));
      noteList.appendChild(div);
    });
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function bindRendition(){
    rendition.on('relocated', (e) => {
      try{ const p = e.location.start.displayed; loc.textContent = p.page + '/' + p.total; }
      catch{ loc.textContent = '‚Äî'; }
    });
    // Khi user b√¥i ƒëen vƒÉn b·∫£n b√™n trong iframe
    rendition.on('selected', async (cfiRange, contents) => {
      try{
        const range = await rendition.getRange(cfiRange);
        const txt = (range?.toString() || '').trim().replace(/\s+/g,' ').slice(0, 300);
        lastSelection = { cfi: cfiRange, text: txt };
        addHLBtn.disabled = false;
      }catch{
        lastSelection = { cfi: cfiRange, text: '' };
        addHLBtn.disabled = false;
      }finally{
        // tr√°nh gi·ªØ highlight native c·ªßa tr√¨nh duy·ªát
        try{ contents.window.getSelection().removeAllRanges(); }catch{}
      }
    });

    // Theme + font size
    rendition.themes.default({
      'body': { 'line-height': '1.6', 'color': '#eaf0ff' },
      'a': { 'color': '#9ad1ff' }
    });
    applyFont(); area.focus();
  }
  function applyFont(){ rendition?.themes.fontSize(fontRange.value + '%'); }

  function unloadBook(){
    rendition?.destroy(); book?.destroy();
    rendition = null; book = null; clearTOC(); loc.textContent = '‚Äî';
    highlights.length = 0; renderNotes();
    lastSelection = null; addHLBtn.disabled = true;
  }

  async function openArrayBuffer(buf){
    unloadBook();
    overlay.style.display='grid'; setStatus('ƒêang m·ªü EPUB‚Ä¶');
    try{
      if (!window.JSZip) throw new Error('JSZip lib not loaded');
      book = ePub(buf);
      rendition = book.renderTo(area, { width: area.clientWidth, height: area.clientHeight, flow:'paginated' });
      await rendition.display();
      bindRendition();
      const navs = await book.loaded.navigation;
      buildTOC(navs);
      setStatus('ƒê√£ t·∫£i xong.');
    }catch(err){
      alert('Kh√¥ng th·ªÉ m·ªü file EPUB.\n\nNguy√™n nh√¢n hay g·∫∑p:\n‚Ä¢ File EPUB h·ªèng / thi·∫øu content.opf\n‚Ä¢ EPUB c√≥ DRM (Adobe, FairPlay)\n‚Ä¢ Khung hi·ªÉn th·ªã b·ªã 0px\n\nChi ti·∫øt:\n' + (err?.message || err));
      setStatus('L·ªói khi m·ªü EPUB');
      console.error(err);
    }finally{
      overlay.style.display='none';
    }
  }

  // === Highlight store (b·ªô nh·ªõ t·∫°m trong phi√™n) ===
  const highlights = []; // { cfi, text, chapter? }

  async function addHighlightFromSelection(){
    if (!lastSelection || !rendition) return;
    const { cfi, text } = lastSelection;

    // T·∫°o highlight m√†u cam trong viewer
    rendition.annotations.add('highlight', cfi, {}, (e)=>{}, 'hl-' + Date.now());

    // L·∫•y t√™n ch∆∞∆°ng (n·∫øu c√≥)
    let chapter = '';
    try{
      const nav = await book.loaded.navigation;
      chapter = nav && nav.toc ? (nav.toc.find(n => (n.href && cfi.includes(n.href)))?.label || '') : '';
    }catch{}

    highlights.push({ cfi, text, chapter });
    renderNotes();

    // reset state
    lastSelection = null; addHLBtn.disabled = true;
    setStatus('ƒê√£ th√™m highlight.');
  }

  // === Events ===
  fileInput.addEventListener('change', async e=>{
    const f = e.target.files?.[0]; if (!f) return;
    const ab = await f.arrayBuffer(); openArrayBuffer(ab);
  });

  prevBtn.addEventListener('click', ()=> rendition?.prev());
  nextBtn.addEventListener('click', ()=> rendition?.next());
  fontRange.addEventListener('input', applyFont);
  addHLBtn.addEventListener('click', addHighlightFromSelection);

  // K√©o‚Äëth·∫£
  ;['dragenter','dragover'].forEach(t=>area.addEventListener(t, e=>{e.preventDefault(); overlay.style.display='grid';}));
  ;['dragleave','dragend','drop'].forEach(t=>area.addEventListener(t, e=>{e.preventDefault(); overlay.style.display='none';}));
  area.addEventListener('drop', async e=>{
    const f = e.dataTransfer.files?.[0];
    if (f && f.name.toLowerCase().endsWith('.epub')) {
      const ab = await f.arrayBuffer(); openArrayBuffer(ab);
    } else setStatus('File kh√¥ng h·ª£p l·ªá. H√£y th·∫£ .epub');
  });

  // Ph√≠m t·∫Øt
  window.addEventListener('keydown', e=>{
    if (!rendition) return;
    if (e.key === 'ArrowLeft') rendition.prev();
    if (e.key === 'ArrowRight') rendition.next();
    if (e.key.toLowerCase()==='h' && !addHLBtn.disabled) addHighlightFromSelection();
  });

})();
</script>
</body>
</html>
