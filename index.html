<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EPUB Reader ‚Äî Single File</title>
<!-- D√πng CDN https (t∆∞∆°ng th√≠ch GitHub Pages & Google Sites iframe) -->
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.js"></script>
<style>
  :root{
    --bg:#0b1020; --card:#0e162b; --muted:#9aa4b2; --text:#eaf0ff;
    --line:#1f2b4a; --accent:#38bdf8; --ok:#22c55e;
    --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0b1020,#101736);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:rgba(14,22,43,.9);backdrop-filter:blur(6px);z-index:10;
    padding:.6rem .8rem;border-bottom:1px solid var(--line);display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid #2a3a63;background:#152043;color:var(--text);padding:.5rem .8rem;border-radius:.6rem;
    cursor:pointer;box-shadow:var(--shadow)}
  .btn:hover{border-color:#3b4f85}
  .btn.primary{border-color:#3aa0ff;background:#16294b}
  input[type="file"]{display:none}
  .chip{padding:.35rem .6rem;border:1px solid #2a3a63;border-radius:999px;font-size:.9rem}
  .grow{flex:1}
  #wrap{display:grid;grid-template-columns:280px 1fr;gap:.8rem;padding:.8rem;height:calc(100vh - 64px)}
  #toc{background:rgba(14,22,43,.6);border:1px solid var(--line);border-radius:.8rem;overflow:auto;padding:.6rem}
  #toc h3{margin:.2rem .4rem .6rem;color:#a7b4c9;font-size:.95rem}
  #toc a{display:block;color:#cfe3ff;text-decoration:none;padding:.35rem .45rem;border-radius:.4rem}
  #toc a:hover{background:#1a2647}
  #stage{background:rgba(14,22,43,.6);border:1px solid var(--line);border-radius:.8rem;overflow:hidden;position:relative}
  #area{height:100%;width:100%}
  #drop{position:absolute;inset:0;display:none;place-items:center;border:2px dashed #2a3a63;border-radius:.8rem;
    color:#a7b4c9;background:rgba(16,23,54,.6)}
  #status{font-size:.9rem;color:var(--muted)}
  .range{accent-color:var(--accent)}
  @media (max-width:900px){
    #wrap{grid-template-columns:1fr}
    #toc{height:240px}
  }
</style>
</head>
<body>
<header>
  <label class="btn primary" for="file">üìñ Ch·ªçn EPUB</label>
  <input id="file" type="file" accept=".epub">
  <button id="prev" class="btn">‚üµ Prev</button>
  <button id="next" class="btn">Next ‚ü∂</button>
  <span class="chip">C·ª° ch·ªØ: <input id="font" type="range" min="80" max="160" value="100" class="range">%</span>
  <span class="chip">Trang: <span id="loc">‚Äî</span></span>
  <div class="grow"></div>
  <span id="status">K√©o & th·∫£ file .epub v√†o v√πng ƒë·ªçc</span>
</header>

<div id="wrap">
  <nav id="toc"><h3>M·ª•c l·ª•c</h3><div id="tocItems"></div></nav>
  <section id="stage">
    <div id="area" tabindex="0"></div>
    <div id="drop"><div style="text-align:center">
      <div style="font-size:2rem; margin-bottom:.4rem">‚¨áÔ∏è Th·∫£ EPUB v√†o ƒë√¢y</div>
      <div>ho·∫∑c d√πng n√∫t ‚ÄúCh·ªçn EPUB‚Äù</div>
    </div></div>
  </section>
</div>

<script>
(() => {
  const fileInput = document.getElementById('file');
  const area = document.getElementById('area');
  const drop = document.getElementById('drop');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const fontRange = document.getElementById('font');
  const loc = document.getElementById('loc');
  const status = document.getElementById('status');
  const tocItems = document.getElementById('tocItems');

  let book = null, rendition = null;

  function setStatus(msg){ status.textContent = msg; }
  function clearTOC(){ tocItems.innerHTML = ""; }

  function buildTOC(navs){
    clearTOC();
    function addItems(items){
      items.forEach(it => {
        const a = document.createElement('a');
        a.textContent = (it.label || '').trim() || '(no title)';
        a.href = '#';
        a.addEventListener('click', (e)=>{ e.preventDefault(); rendition.display(it.href); });
        tocItems.appendChild(a);
        if (it.subitems && it.subitems.length) addItems(it.subitems);
      });
    }
    addItems(navs.toc || []);
  }

  function bindRendition(){
    rendition.on('relocated', (e) => {
      try {
        const p = e.location.start.displayed;
        loc.textContent = p.page + '/' + p.total;
      } catch { loc.textContent = '‚Äî'; }
    });
    rendition.themes.default({
      'body': { 'line-height': '1.6', 'color': '#eaf0ff' },
      'a': { 'color': '#9ad1ff' }
    });
    applyFont();
    area.focus();
  }

  function applyFont(){ if (rendition) rendition.themes.fontSize(fontRange.value + '%'); }

  function unloadBook(){
    if (rendition) { rendition.destroy(); rendition = null; }
    if (book) { book.destroy(); book = null; }
    clearTOC();
    loc.textContent = '‚Äî';
  }

  async function openArrayBuffer(buf){
    unloadBook();
    setStatus('ƒêang m·ªü EPUB‚Ä¶');
    book = ePub(buf);
    rendition = book.renderTo(area, { width: '100%', height: '100%' });
    await rendition.display();
    bindRendition();
    const navs = await book.loaded.navigation;
    buildTOC(navs);
    setStatus('ƒê√£ t·∫£i xong.');
  }

  // File input
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const ab = await f.arrayBuffer();
    openArrayBuffer(ab);
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(t => area.addEventListener(t, (e)=>{ e.preventDefault(); drop.style.display='grid'; }));
  ['dragleave','dragend','drop'].forEach(t => area.addEventListener(t, (e)=>{ e.preventDefault(); drop.style.display='none'; }));
  area.addEventListener('drop', async (e)=>{
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f && f.name.toLowerCase().endsWith('.epub')) {
      const ab = await f.arrayBuffer();
      openArrayBuffer(ab);
    } else {
      setStatus('File kh√¥ng h·ª£p l·ªá. H√£y th·∫£ file .epub');
    }
  });

  // Controls
  prevBtn.addEventListener('click', ()=> rendition && rendition.prev());
  nextBtn.addEventListener('click', ()=> rendition && rendition.next());
  fontRange.addEventListener('input', applyFont);

  // Keyboard
  window.addEventListener('keydown', (e)=>{
    if (!rendition) return;
    if (e.key === 'ArrowLeft') rendition.prev();
    if (e.key === 'ArrowRight') rendition.next();
  });

  // Tip khi nh√∫ng v√†o Google Sites b·∫±ng iframe: kh√¥ng c·∫ßn g√¨ th√™m.
})();
</script>
</body>
</html>
