<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EPUB Reader ‚Äî Safe Render</title>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.js"></script>
<style>
  :root{ --bg:#0b1020; --card:#0e162b; --muted:#9aa4b2; --text:#eaf0ff; --line:#1f2b4a; --accent:#38bdf8 }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0b1020,#101736);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(14,22,43,.9);backdrop-filter:blur(6px);
         border-bottom:1px solid var(--line);display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;padding:.6rem .8rem}
  .btn{border:1px solid #2a3a63;background:#152043;color:var(--text);padding:.5rem .8rem;border-radius:.6rem;cursor:pointer}
  .btn.primary{border-color:#3aa0ff;background:#16294b}
  input[type="file"]{display:none}
  .chip{padding:.35rem .6rem;border:1px solid #2a3a63;border-radius:999px;font-size:.9rem}
  .grow{flex:1}
  #wrap{display:grid;grid-template-columns:280px 1fr;gap:.8rem;padding:.8rem;min-height:calc(100vh - 64px)}
  #toc{background:rgba(14,22,43,.6);border:1px solid var(--line);border-radius:.8rem;overflow:auto;padding:.6rem}
  #toc h3{margin:.2rem .4rem .6rem;color:#a7b4c9;font-size:.95rem}
  #toc a{display:block;color:#cfe3ff;text-decoration:none;padding:.35rem .45rem;border-radius:.4rem}
  #toc a:hover{background:#1a2647}
  #stage{background:rgba(14,22,43,.6);border:1px solid var(--line);border-radius:.8rem;position:relative;min-height:320px}
  #area{width:100%;height:100%;overflow:auto}
  #overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(16,23,54,.4);backdrop-filter:blur(2px)}
  #status{font-size:.9rem;color:var(--muted)}
  #log{font-size:.8rem;color:#9ad1ff}
  .range{accent-color:var(--accent)}
  @media (max-width:900px){ #wrap{grid-template-columns:1fr} #toc{height:240px} }
</style>
</head>
<body>
<header>
  <label class="btn primary" for="file">üìñ Ch·ªçn EPUB</label>
  <input id="file" type="file" accept=".epub">
  <button id="prev" class="btn">‚üµ Prev</button>
  <button id="next" class="btn">Next ‚ü∂</button>
  <span class="chip">C·ª° ch·ªØ: <input id="font" type="range" min="80" max="160" value="100" class="range">%</span>
  <span class="chip">Trang: <span id="loc">‚Äî</span></span>
  <div class="grow"></div>
  <span id="status">S·∫µn s√†ng. Ch·ªçn/ k√©o‚Äëth·∫£ .epub</span>
  <span id="log"></span>
</header>

<div id="wrap">
  <nav id="toc"><h3>M·ª•c l·ª•c</h3><div id="tocItems"></div></nav>
  <section id="stage">
    <div id="area" tabindex="0"></div>
    <div id="overlay" style="display:grid"><div>
      <div style="font-size:1.2rem;text-align:center">‚è≥ ƒêang m·ªü EPUB‚Ä¶</div>
    </div></div>
  </section>
</div>

<script>
(() => {
  const q = id => document.getElementById(id);
  const fileInput = q('file'), area = q('area'), stage = q('stage');
  const prevBtn = q('prev'), nextBtn = q('next'), fontRange = q('font');
  const loc = q('loc'), status = q('status'), tocItems = q('tocItems'), overlay = q('overlay'), logEl = q('log');
  let book = null, rendition = null, resizeObs = null;

  function setStatus(s){ status.textContent = s; }
  function log(s){ logEl.textContent = s; console.log('[EPUB]', s); }
  function clearTOC(){ tocItems.innerHTML = ""; }

  // ƒê·∫£m b·∫£o #area lu√¥n c√≥ chi·ªÅu cao th·∫≠t (tr√°nh 100% c·ªßa container ch∆∞a ƒëo ƒë∆∞·ª£c)
  function attachResizer(){
    if (resizeObs) return;
    resizeObs = new ResizeObserver(() => {
      const h = stage.clientHeight;
      area.style.height = (h>0? h : 400) + 'px';
    });
    resizeObs.observe(stage);
    // ƒë·∫∑t ngay l·∫ßn ƒë·∫ßu
    area.style.height = Math.max(stage.clientHeight, 400) + 'px';
  }

  function buildTOC(navs){
    clearTOC();
    const add = items => items.forEach(it=>{
      const a = document.createElement('a');
      a.textContent = (it.label||'').trim() || '(no title)';
      a.href = '#';
      a.addEventListener('click', e=>{ e.preventDefault(); rendition.display(it.href); });
      tocItems.appendChild(a);
      if (it.subitems?.length) add(it.subitems);
    });
    add(navs.toc || []);
  }

  function bindRendition(){
    rendition.on('relocated', (e) => {
      try {
        const p = e.location.start.displayed;
        loc.textContent = p.page + '/' + p.total;
      } catch { loc.textContent = '‚Äî'; }
    });
    rendition.themes.default({
      'body': { 'line-height': '1.6', 'color': '#eaf0ff' },
      'a': { 'color': '#9ad1ff' }
    });
    applyFont();
    area.focus();
  }

  function applyFont(){ if (rendition) rendition.themes.fontSize(fontRange.value + '%'); }

  function unloadBook(){
    if (rendition) { rendition.destroy(); rendition = null; }
    if (book) { book.destroy(); book = null; }
    clearTOC(); loc.textContent = '‚Äî';
  }

  async function openArrayBuffer(buf){
    unloadBook();
    setStatus('ƒêang m·ªü EPUB‚Ä¶'); overlay.style.display='grid'; log('start open');
    attachResizer();

    let timeoutId = setTimeout(()=>{
      log('timeout> rendering l√¢u b·∫•t th∆∞·ªùng. C√≥ th·ªÉ chi·ªÅu cao v√πng ƒë·ªçc = 0 ho·∫∑c EPUB l·ªói/DRM.');
      setStatus('Ch·∫≠m b·∫•t th∆∞·ªùng‚Ä¶ ki·ªÉm tra file ho·∫∑c th·ª≠ t·∫£i l·∫°i.');
      overlay.style.display='none';
    }, 10000);

    try{
      book = ePub(buf);
      // DEBUG: n·∫øu EPUB c√≥ DRM (encryption.xml), epub.js kh√¥ng ƒë·ªçc ƒë∆∞·ª£c
      book.ready.then(()=>log('book.ready'));
      rendition = book.renderTo(area, { width: area.clientWidth, height: area.clientHeight, flow:'paginated' });
      await rendition.display(); // c√≥ th·ªÉ treo n·∫øu height=0 ‚Üí ƒë√£ c√≥ resizer
      bindRendition();
      const navs = await book.loaded.navigation;
      buildTOC(navs);
      setStatus('ƒê√£ t·∫£i xong.'); log('display done');
    }catch(err){
      console.error(err);
      setStatus('L·ªói khi m·ªü EPUB');
      alert(
        'Kh√¥ng th·ªÉ m·ªü file EPUB.\n\nNguy√™n nh√¢n hay g·∫∑p:\n' +
        '‚Ä¢ File EPUB h·ªèng ho·∫∑c kh√¥ng theo chu·∫©n (ZIP l·ªói, thi·∫øu content.opf)\n' +
        '‚Ä¢ EPUB c√≥ DRM (Adobe/FairPlay) ‚Üí epub.js kh√¥ng ƒë·ªçc ƒë∆∞·ª£c\n' +
        '‚Ä¢ V√πng hi·ªÉn th·ªã b·ªã ch·∫∑n/kh√¥ng c√≥ chi·ªÅu cao\n\nChi ti·∫øt:\n' + (err?.message || err)
      );
    }finally{
      clearTimeout(timeoutId);
      overlay.style.display='none';
    }
  }

  // Events
  fileInput.addEventListener('change', async e=>{
    const f = e.target.files?.[0];
    if (!f) return;
    const ab = await f.arrayBuffer();
    openArrayBuffer(ab);
  });

  prevBtn.addEventListener('click', ()=> rendition?.prev());
  nextBtn.addEventListener('click', ()=> rendition?.next());
  fontRange.addEventListener('input', applyFont);

  // K√©o‚Äëth·∫£ tr·ª±c ti·∫øp l√™n v√πng ƒë·ªçc
  ;['dragenter','dragover'].forEach(t=>area.addEventListener(t, e=>{e.preventDefault(); overlay.style.display='grid';}));
  ;['dragleave','dragend','drop'].forEach(t=>area.addEventListener(t, e=>{e.preventDefault(); overlay.style.display='none';}));
  area.addEventListener('drop', async e=>{
    const f = e.dataTransfer.files?.[0];
    if (f && f.name.toLowerCase().endsWith('.epub')) {
      const ab = await f.arrayBuffer();
      openArrayBuffer(ab);
    } else {
      setStatus('File kh√¥ng h·ª£p l·ªá. H√£y th·∫£ .epub'); log('drop not epub');
    }
  });

  // Ph√≠m t·∫Øt
  window.addEventListener('keydown', e=>{
    if (!rendition) return;
    if (e.key === 'ArrowLeft') rendition.prev();
    if (e.key === 'ArrowRight') rendition.next();
  });

  // N·∫øu iframe/Sites l√†m chi·ªÅu cao dynamic ‚Üí resizer s·∫Ω x·ª≠ l√Ω
  attachResizer();
})();
</script>
</body>
</html>
