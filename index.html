<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>EPUB Reader ‚Äî JSZip Fixed</title>

<!-- MUST: JSZip tr∆∞·ªõc -->
<script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
<!-- epub.js sau -->
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.js"></script>

<style>
  :root{ --bg:#0b1020; --card:#0e162b; --muted:#9aa4b2; --text:#eaf0ff; --line:#1f2b4a; --accent:#38bdf8 }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(120deg,#0b1020,#101736);color:var(--text);
       font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;z-index:10;background:rgba(14,22,43,.9);backdrop-filter:blur(6px);
         border-bottom:1px solid var(--line);display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;padding:.6rem .8rem}
  .btn{border:1px solid #2a3a63;background:#152043;color:var(--text);padding:.5rem .8rem;border-radius:.6rem;cursor:pointer}
  .btn.primary{border-color:#3aa0ff;background:#16294b}
  input[type="file"]{display:none}
  .chip{padding:.35rem .6rem;border:1px solid #2a3a63;border-radius:999px;font-size:.9rem}
  .grow{flex:1}
  #wrap{display:grid;grid-template-columns:280px 1fr;gap:.8rem;padding:.8rem;min-height:calc(100vh - 64px)}
  #toc{background:rgba(14,22,43,.6);border:1px solid var(--line);border-radius:.8rem;overflow:auto;padding:.6rem}
  #toc h3{margin:.2rem .4rem .6rem;color:#a7b4c9;font-size:.95rem}
  #toc a{display:block;color:#cfe3ff;text-decoration:none;padding:.35rem .45rem;border-radius:.4rem}
  #toc a:hover{background:#1a2647}
  #stage{background:rgba(14,22,43,.6);border:1px solid var(--line);border-radius:.8rem;position:relative;min-height:360px}
  #area{width:100%;height:100%;overflow:auto}
  #overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(16,23,54,.4);backdrop-filter:blur(2px)}
  #status{font-size:.9rem;color:var(--muted)}
</style>
</head>
<body>
<header>
  <label class="btn primary" for="file">üìñ Ch·ªçn EPUB</label>
  <input id="file" type="file" accept=".epub">
  <button id="prev" class="btn">‚üµ Prev</button>
  <button id="next" class="btn">Next ‚ü∂</button>
  <span class="chip">C·ª° ch·ªØ: <input id="font" type="range" min="80" max="160" value="100">%</span>
  <span class="chip">Trang: <span id="loc">‚Äî</span></span>
  <div class="grow"></div>
  <span id="status">S·∫µn s√†ng. Ch·ªçn/k√©o‚Äëth·∫£ .epub</span>
</header>

<div id="wrap">
  <nav id="toc"><h3>M·ª•c l·ª•c</h3><div id="tocItems"></div></nav>
  <section id="stage">
    <div id="area" tabindex="0"></div>
    <div id="overlay" style="display:grid"><div>
      <div style="font-size:1.2rem;text-align:center">‚è≥ ƒêang m·ªü EPUB‚Ä¶</div>
    </div></div>
  </section>
</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const fileInput = $('file'), area = $('area'), stage = $('stage'), overlay = $('overlay');
  const prevBtn = $('prev'), nextBtn = $('next'), fontRange = $('font');
  const loc = $('loc'), status = $('status'), tocItems = $('tocItems');
  let book = null, rendition = null;

  function setStatus(s){ status.textContent = s; }
  function clearTOC(){ tocItems.innerHTML = ""; }
  function ensureHeight(){
    const h = stage.clientHeight || 400;
    area.style.height = h + 'px';
  }
  new ResizeObserver(ensureHeight).observe(stage);
  ensureHeight();

  function buildTOC(navs){
    clearTOC();
    const add = items => items.forEach(it=>{
      const a = document.createElement('a');
      a.textContent = (it.label||'').trim() || '(no title)';
      a.href = '#';
      a.addEventListener('click', e=>{ e.preventDefault(); rendition.display(it.href); });
      tocItems.appendChild(a);
      if (it.subitems?.length) add(it.subitems);
    });
    add(navs.toc || []);
  }

  function bindRendition(){
    rendition.on('relocated', (e) => {
      try {
        const p = e.location.start.displayed;
        loc.textContent = p.page + '/' + p.total;
      } catch { loc.textContent = '‚Äî'; }
    });
    rendition.themes.default({ 'body': { 'line-height': '1.6', 'color': '#eaf0ff' } });
    applyFont(); area.focus();
  }
  function applyFont(){ rendition?.themes.fontSize(fontRange.value + '%'); }

  function unloadBook(){
    rendition?.destroy(); book?.destroy();
    rendition = null; book = null; clearTOC(); loc.textContent = '‚Äî';
  }

  async function openArrayBuffer(buf){
    unloadBook();
    overlay.style.display='grid'; setStatus('ƒêang m·ªü EPUB‚Ä¶');
    try{
      if (!window.JSZip) throw new Error('JSZip lib not loaded');
      book = ePub(buf);
      rendition = book.renderTo(area, { width: area.clientWidth, height: area.clientHeight, flow:'paginated' });
      await rendition.display();
      bindRendition();
      const navs = await book.loaded.navigation;
      buildTOC(navs);
      setStatus('ƒê√£ t·∫£i xong.');
    }catch(err){
      alert(
        'Kh√¥ng th·ªÉ m·ªü file EPUB.\n\nNguy√™n nh√¢n hay g·∫∑p:\n' +
        '‚Ä¢ File EPUB h·ªèng ho·∫∑c kh√¥ng theo chu·∫©n (ZIP l·ªói, thi·∫øu content.opf)\n' +
        '‚Ä¢ EPUB c√≥ DRM (Adobe/FairPlay) ‚Üí epub.js kh√¥ng ƒë·ªçc ƒë∆∞·ª£c\n' +
        '‚Ä¢ V√πng hi·ªÉn th·ªã b·ªã ch·∫∑n/kh√¥ng c√≥ chi·ªÅu cao\n\nChi ti·∫øt:\n' + (err?.message || err)
      );
      setStatus('L·ªói khi m·ªü EPUB');
      console.error(err);
    }finally{
      overlay.style.display='none';
    }
  }

  // Input & DnD
  fileInput.addEventListener('change', async e=>{
    const f = e.target.files?.[0]; if (!f) return;
    const ab = await f.arrayBuffer(); openArrayBuffer(ab);
  });
  ;['dragenter','dragover'].forEach(t=>area.addEventListener(t, e=>{e.preventDefault(); overlay.style.display='grid';}));
  ;['dragleave','dragend','drop'].forEach(t=>area.addEventListener(t, e=>{e.preventDefault(); overlay.style.display='none';}));
  area.addEventListener('drop', async e=>{
    const f = e.dataTransfer.files?.[0];
    if (f && f.name.toLowerCase().endsWith('.epub')) {
      const ab = await f.arrayBuffer(); openArrayBuffer(ab);
    } else setStatus('File kh√¥ng h·ª£p l·ªá. H√£y th·∫£ .epub');
  });

  // Controls
  prevBtn.addEventListener('click', ()=> rendition?.prev());
  nextBtn.addEventListener('click', ()=> rendition?.next());
  fontRange.addEventListener('input', applyFont);

  window.addEventListener('keydown', e=>{
    if (!rendition) return;
    if (e.key === 'ArrowLeft') rendition.prev();
    if (e.key === 'ArrowRight') rendition.next();
  });
})();
</script>
</body>
</html>
